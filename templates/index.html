<!DOCTYPE html>
<html>
<head>
    <title>{% if target_item_data and target_item_data.text %}{{ target_item_data.text|truncate(60) }} - MailMap{% else %}MailMap{% endif %}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO metadata -->
    {% if target_item_data %}
    <meta name="description" content="{% if target_item_data.text %}{{ target_item_data.text|truncate(155) }}{% else %}Like me! Post on MailMap{% endif %}">
    <meta property="og:title" content="{% if target_item_data.text %}{{ target_item_data.text|truncate(60) }} - MailMap{% else %}Like me! MailMap{% endif %}">
    <meta property="og:description" content="{% if target_item_data.text %}{{ target_item_data.text|truncate(155) }}{% else %}Like me! Post on the MailMap{% endif %}">
    {% if target_item_data.imageUrl %}
    <meta property="og:image" content="{{ target_item_data.imageUrl }}">
    {% endif %}
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="MailMap">
    <meta name="twitter:card" content="summary_large_image">
    {% else %}
    <meta name="description" content="MailMap - send and view posts on the map">
    <meta property="og:title" content="MailMap - Interactive Post Map">
    <meta property="og:description" content="Send and view posts on an interactive map">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="MailMap">
    {% endif %}

    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/share-buttons.css">
    <link rel="stylesheet" href="/static/css/add-photo.css">

    <style>
        .challenge-message {
            position: fixed;
            bottom: 20px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
            z-index: 1000;
        }
        .challenge-message a {
            color: #007bff;
            text-decoration: none;
        }
        .challenge-message a:hover {
            text-decoration: underline;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="{{ url_for('static', filename='js/firebase-init.js') }}"></script>
</head>
<body>

    <nav class="user-info-bar">
        {% if session.user_id %}
            <span>Welcome, {{ session.user_displayName }} ({{ session.user_email }})</span>
            {% if remaining_photos is not none %}
                <span style="margin-left: 10px;">Photos remaining: {{ remaining_photos }}</span>
            {% endif %}
            <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
            <a href="{{ url_for('login') }}">Login</a>
            <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
        <a href="{{ url_for('help_page') }}">Help</a>
    </nav>

    <!-- Фильтры для карты -->
    <div class="map-filters" style="position: fixed; top: 80px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <button id="filter-all" {% if not filtered_user_id %}class="active-filter"{% endif %}>All foto</button>
        {% if user_id_session %} <!-- Показываем кнопку "Мои фото" только залогиненным -->
        <button id="filter-my" {% if filtered_user_id and filtered_user_id == user_id_session %}class="active-filter"{% endif %}>My foto</button>
        {% endif %}
        {% if filtered_user_id and filtered_user_id != user_id_session %}
        <span class="filter-info">Фото пользователя {{ filtered_user_id }}</span>
        {% endif %}
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Loading indicator -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Challenge message -->
    <div class="challenge-message">
        This service was developed for the <a href="https://dev.to/prema_ananda/mailmap-transforming-emails-into-interactive-stories-on-google-maps-1f10" target="_blank">Postmark Challenge: Inbox Innovators</a>
    </div>

    <!-- Firebase initialization -->
    <script>
        // Firebase app is initialized in firebase-init.js
        let currentUser = null;
        const userIdFromServerSession = {{ user_id_session|tojson }}; // Get server session status

        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in to Firebase client-side
                console.log("Firebase client: User is authenticated:", user.uid, user.displayName);
                currentUser = user;
                // If server session doesn't match client, could indicate logout elsewhere.
                // For now, client-side Firebase state takes precedence for `currentUser`.
                // The navigation bar will reflect server session.
            } else {
                // No user signed in to Firebase client-side
                console.log("Firebase client: No user authenticated.");
                if (userIdFromServerSession) {
                    // Server session exists, but Firebase client is signed out.
                    // This can happen if user logged in via email/pass (no client Firebase session)
                    // or if Firebase session expired / signed out, but server session persists.
                    // We probably don't want to auto signInAnonymously if a server session exists.
                    console.log("Server session exists for:", userIdFromServerSession, "Not signing in anonymously.");
                    // currentUser remains null, or you could create a dummy user object if needed
                    // for client-side logic that expects `currentUser`.
                } else {
                    // No client Firebase user AND no server session, so sign in anonymously.
                    console.log("No server session and no client Firebase user. Signing in anonymously.");
                    firebase.auth().signInAnonymously()
                        .then(function(result) {
                            console.log("Anonymous authentication successful", result.user.uid);
                            currentUser = result.user;
                        })
                        .catch(function(error) {
                            console.error("Error in anonymous authentication:", error);
                        });
                }
            }
        });

        const mapData = {{ items|tojson|safe }};

        // Pass the target item ID, if any
        // eslint-disable-next-line
        'use strict';
        let targetItemId = {% if target_item_id %}"{{ target_item_id }}"{% else %}null{% endif %};

        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Data is ready, pass it to map.js to store and attempt to populate
            if (typeof setMapItemsAndPopulate === 'function') {
                setMapItemsAndPopulate(mapData, targetItemId);
            } else {
                console.error('setMapItemsAndPopulate function not found. Ensure map.js is loaded before this script.');
            }

            // Обработка кнопок фильтрации с правильной обработкой URL
            const filterAllButton = document.getElementById('filter-all');
            const filterMyButton = document.getElementById('filter-my');

            function setFilterInUrl(filterValue, userId) {
                // Start with the root path
                const newPath = '/';
                const url = new URL(newPath, window.location.origin); // Construct URL relative to origin

                if (filterValue === 'all') {
                    // For 'all', ensure no userId parameter is present
                    url.searchParams.delete('userId');
                } else if (userId) {
                    // For 'user', set the userId parameter
                    url.searchParams.set('userId', userId);
                }
                // Any other existing query parameters on the current page will be discarded,
                // which is the desired behavior for these global filter buttons.

                // Navigate to the new URL
                window.location.href = url.toString();
            }

            if (filterAllButton) {
                filterAllButton.addEventListener('click', function() {
                    setFilterInUrl('all');
                });
            }
            if (filterMyButton && userIdFromServerSession) {
                filterMyButton.addEventListener('click', function() {
                    setFilterInUrl('user', userIdFromServerSession);
                });
            }

            // Для отладки
            console.log('Current URL:', window.location.href);
            console.log('Filter buttons initialized with improved URL handling');
        });

        // This function will be the callback for the Google Maps API script
        function onGoogleMapsApiLoaded() {
            if (typeof initMapCore === 'function') {
                initMapCore(); // Initialize map core, which will then try to populate markers
            } else {
                console.error('initMapCore function not found. Ensure map.js is loaded.');
            }
        }
    </script>

    <!-- Include JS files -->
    <script src="/static/js/map.js"></script>
    <script src="/static/js/content-actions.js"></script>

    <!-- Google Maps API -->
    <script async
        src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&callback=onGoogleMapsApiLoaded&libraries=marker&v=beta">
    </script>
</body>
</html>