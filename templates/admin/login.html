<!DOCTYPE html>
<html>
<head>
    <title>MailMap - Administrator Login</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body class="admin-page">
    <div class="admin-container">
        <div class="admin-login-box">
            <h1>MailMap</h1>
            <h2>Moderator Login</h2>

            <div id="admin-error-message" class="error-message" style="display: none;"></div>
            {% if error %}
            {# This server-side error might still be useful if GET request has an error to show #}
            {# For JS-driven errors, the admin-error-message div above will be used #}
            <div class="error-message">{{ error }}</div>
            {% endif %}

            <form method="POST" action="/admin/login" id="admin-login-form">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Login</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <!-- It's important to use the Firebase version compatible with your project if specified elsewhere -->
    <!-- Using a generic version placeholder like 9.x.x, replace with actual version if known -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <!-- Firebase Configuration & Initialization -->
    <!-- This assumes firebase-init.js initializes firebase app like: firebase.initializeApp(config); -->
    <script src="/static/js/firebase-init.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const adminLoginForm = document.getElementById('admin-login-form');
            const errorMessageElement = document.getElementById('admin-error-message');

            if (adminLoginForm) {
                adminLoginForm.addEventListener('submit', function(event) {
                    event.preventDefault(); // Prevent default form submission

                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;

                    // Clear previous errors and hide the error message div
                    errorMessageElement.textContent = '';
                    errorMessageElement.style.display = 'none';

                    if (!firebase || !firebase.auth) {
                        console.error('Firebase Auth is not initialized.');
                        errorMessageElement.textContent = 'Firebase is not available. Please try again later.';
                        errorMessageElement.style.display = 'block';
                        return;
                    }

                    const auth = firebase.auth();

                    auth.signInWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            // User signed in with Firebase
                            return userCredential.user.getIdToken();
                        })
                        .then((idToken) => {
                            // Send this ID token to your backend /admin/login endpoint
                            return fetch('/admin/login', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ idToken: idToken }),
                            });
                        })
                        .then(response => {
                            // It's good practice to check if response is ok before parsing JSON
                            if (!response.ok) {
                                // Attempt to parse error response from backend
                                return response.json().then(errData => {
                                    throw new Error(errData.message || `Server error: ${response.status}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'success' && data.redirect_url) {
                                window.location.href = data.redirect_url; // Redirect to admin dashboard
                            } else {
                                // Handle login failure (e.g., display error message from data.message)
                                console.error('Admin login failed:', data.message);
                                errorMessageElement.textContent = data.message || 'Admin login failed. Please check your credentials or admin status.';
                                errorMessageElement.style.display = 'block';
                            }
                        })
                        .catch((error) => {
                            // Handle errors (e.g., invalid Firebase credentials, network error, error from backend)
                            console.error('Error during admin sign-in:', error);
                            let displayMessage = error.message;
                            if (error.code) { // Firebase specific error codes
                                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                                    displayMessage = 'Invalid email or password.';
                                } else if (error.code === 'auth/invalid-email') {
                                    displayMessage = 'Please enter a valid email address.';
                                }
                            }
                            errorMessageElement.textContent = displayMessage;
                            errorMessageElement.style.display = 'block';
                        });
                });
            }
        });
    </script>
</body>
</html>
