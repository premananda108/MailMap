# Changelog - Webhook Improvements

## [2.0.0] - 2024-01-XX

### Added
- **Модульная архитектура**: Система разделена на отдельные модули для лучшей организации кода
- **Автоматическое создание пользователей**: Пользователи создаются автоматически при первом email
- **Система лимитов загрузки**: Настраиваемые лимиты на количество загрузок фотографий в месяц
- **Обработка множественных изображений**: Каждое изображение в письме обрабатывается отдельно
- **Улучшенная обработка ошибок**: Graceful degradation при ошибках обработки
- **Детальное логирование**: Подробные логи на каждом этапе обработки

### Changed
- **Переработана функция вебхука**: Полностью новая логика обработки в `webhook_handler.py`
- **Улучшена обработка изображений**: Добавлена функция `process_uploaded_image` в `image_utils.py`
- **Обновлена конфигурация**: Централизованная конфигурация через `utils.get_app_config()`

### New Files
- `webhook_handler.py` - Основная логика обработки вебхуков
- `firestore_utils.py` - Утилиты для работы с Firestore
- `utils.py` - Общие утилиты и конфигурация
- `WEBHOOK_IMPROVEMENTS.md` - Документация по улучшениям

### Enhanced Files
- `app.py` - Обновлена функция вебхука для использования нового обработчика
- `image_utils.py` - Добавлены функции для обработки загруженных изображений

### Configuration
- Добавлена переменная окружения `PHOTO_UPLOAD_LIMIT` для настройки лимитов
- Централизованная конфигурация через `utils.get_app_config()`

### Database Schema
- Новая коллекция `users` с полями:
  - `uid` - уникальный идентификатор пользователя
  - `email` - email адрес
  - `displayName` - отображаемое имя
  - `provider` - провайдер (email_webhook)
  - `photo_upload_count_current_month` - счетчик загрузок за месяц
  - `last_upload_reset` - дата последнего сброса счетчика
  - `isActive` - статус активности

### API Changes
- Обновлены ответы вебхука для включения информации о пропущенных изображениях
- Добавлены поля `contentIds` и `skipped_count` в ответы

### Breaking Changes
- Изменена структура ответов вебхука
- Добавлена зависимость от новых модулей
- Требуется настройка переменной окружения `PHOTO_UPLOAD_LIMIT`

### Migration Notes
- Существующие пользователи продолжат работать
- Новые пользователи будут создаваться автоматически
- Лимиты применяются только к новым пользователям
- Существующий контент остается без изменений 