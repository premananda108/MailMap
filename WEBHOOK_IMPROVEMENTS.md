# Улучшения обработки вебхуков Postmark

## Обзор изменений

Система обработки вебхуков была полностью переработана для повышения надежности, производительности и функциональности.

## Основные улучшения

### 1. Модульная архитектура

Система разделена на отдельные модули:
- `webhook_handler.py` - основная логика обработки вебхуков
- `firestore_utils.py` - утилиты для работы с Firestore
- `utils.py` - общие утилиты (валидация, парсинг, конфигурация)
- `image_utils.py` - обработка изображений (расширена)

### 2. Управление пользователями

#### Автоматическое создание пользователей
- При получении email от неизвестного адреса автоматически создается пользователь
- Пользователю присваивается уникальный UID
- Сохраняется информация о провайдере (`email_webhook`)

#### Отслеживание лимитов загрузки
- Каждый пользователь имеет счетчик загрузок за текущий месяц
- Лимит настраивается через переменную окружения `PHOTO_UPLOAD_LIMIT`
- Автоматический сброс счетчика в начале нового месяца

### 3. Улучшенная обработка изображений

#### Проверка лимитов для каждого изображения
- Лимит проверяется для каждого изображения отдельно
- Если пользователь достиг лимита, пропускаются только новые изображения
- Обработанные изображения сохраняются

#### Инкремент счетчика после успешного сохранения
- Счетчик увеличивается только после успешного сохранения контента
- Предотвращает потерю лимитов при ошибках обработки

### 4. Обработка множественных изображений

#### Обработка всех изображений в письме
- Каждое изображение обрабатывается отдельно
- Для каждого изображения создается отдельная запись в базе данных
- Координаты определяются индивидуально для каждого изображения

#### Гибкая система координат
1. Приоритет: EXIF GPS данные из изображения
2. Резерв: координаты из темы письма
3. Пропуск изображения, если координаты не найдены

### 5. Улучшенная обработка ошибок

#### Детальное логирование
- Логирование на каждом этапе обработки
- Информация о пропущенных изображениях
- Статистика обработки

#### Graceful degradation
- Ошибка обработки одного изображения не прерывает обработку остальных
- Частичный успех: некоторые изображения обработаны, некоторые пропущены

## Конфигурация

### Переменные окружения

```bash
# Лимит загрузки фотографий (0 = без лимита)
PHOTO_UPLOAD_LIMIT=10

# Токен для вебхуков Postmark
INBOUND_URL_TOKEN=your_token_here

# Firebase конфигурация
FIREBASE_STORAGE_BUCKET=your-project.appspot.com

# Google Maps API
GOOGLE_MAPS_API_KEY=your_api_key_here

# Flask секретный ключ
FLASK_SECRET_KEY=your_secret_key_here
```

### Структура данных пользователя

```json
{
  "uid": "unique_user_id",
  "email": "user@example.com",
  "displayName": "user",
  "provider": "email_webhook",
  "createdAt": "2024-01-01T00:00:00Z",
  "photo_upload_count_current_month": 5,
  "last_upload_reset": "2024-01-01T00:00:00Z",
  "isActive": true
}
```

## API ответы

### Успешная обработка
```json
{
  "status": "success",
  "contentIds": ["id1", "id2"],
  "message": "2 content item(s) published successfully",
  "skipped_count": 0
}
```

### Частичный успех
```json
{
  "status": "partial_success",
  "contentIds": ["id1"],
  "message": "1 content item(s) published successfully, 1 image(s) skipped due to upload limit",
  "skipped_count": 1
}
```

### Ошибка
```json
{
  "status": "error",
  "message": "No valid images found in attachments"
}
```

## Тестирование

Запустите тестовый скрипт:
```bash
python test_webhook.py
```

## Миграция

### Для существующих пользователей
- Существующие пользователи будут работать без изменений
- Новые пользователи будут создаваться автоматически
- Лимиты применяются только к новым пользователям

### Для существующего контента
- Существующий контент остается без изменений
- Новый контент будет связан с пользователями

## Мониторинг

### Логи для отслеживания
- Создание новых пользователей
- Обработка изображений
- Достижение лимитов
- Ошибки обработки

### Метрики
- Количество обработанных изображений
- Количество пропущенных изображений
- Время обработки
- Ошибки по типам

## Безопасность

### Валидация входных данных
- Проверка токенов
- Валидация email адресов
- Проверка типов файлов
- Ограничение размера файлов

### Ограничения доступа
- Лимиты на количество загрузок
- Временные ограничения
- Проверка прав доступа

## Производительность

### Оптимизации
- Пакетная обработка изображений
- Кэширование пользовательских данных
- Асинхронная обработка уведомлений
- Эффективное использование памяти

### Масштабируемость
- Модульная архитектура
- Независимая обработка изображений
- Горизонтальное масштабирование
- Очереди обработки 